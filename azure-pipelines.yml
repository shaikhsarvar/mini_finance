trigger:
- main  # Or your specific branch name

pool:
  name: 'local pc'  # Your self-hosted agent name

variables:
  dockerHubUsername: 'sksarvar'
  imageName: 'ubuntu-app'
  imageTag: 'v2.1'
  dockerRegistryServiceConnection: 'dockerhub-azuredevops'
  sonarProjectKey: 'mini-finance'
  sonarHostUrl: 'http://localhost:9000'
  sonarLogin: '$(SONAR_TOKEN)'  # Store as a secret variable in pipeline
  dockerfilePath: '**/Dockerfile'

steps:
# üßæ Checkout the repo
- checkout: self
  displayName: 'Checkout source code'

# üîç 1. Prepare SonarQube Analysis
- task: SonarQubePrepare@5
  inputs:
    SonarQube: 'SonarQube'  # Your SonarQube service connection name
    scannerMode: 'CLI'
    configMode: 'manual'
    cliProjectKey: '$(sonarProjectKey)'
    cliSources: '.'
    cliHostUrl: '$(sonarHostUrl)'
    cliLogin: '$(sonarLogin)'

# üöÄ 2. Run SonarQube Scanner (using full path to fix PATH issue)
- script: |
    "C:\sonar-scanner\bin\sonar-scanner.bat" ^
    -Dsonar.projectKey=$(sonarProjectKey) ^
    -Dsonar.sources=. ^
    -Dsonar.host.url=$(sonarHostUrl) ^
    -Dsonar.login=$(sonarLogin) ^
    -Dsonar.branch.name=""  # Disable branch analysis
  displayName: 'Run SonarQube Scanner (Full Path)'


# üìà 3. Publish SonarQube Results
- task: SonarQubeAnalyze@5

# üõ†Ô∏è 4. Build and Push Docker Image
- task: Docker@2
  displayName: 'Build and Push Docker Image to Docker Hub'
  inputs:
    containerRegistry: $(dockerRegistryServiceConnection)
    repository: '$(dockerHubUsername)/$(imageName)'
    command: 'buildAndPush'
    Dockerfile: '$(dockerfilePath)'
    tags: |
      $(imageTag)

# üöÄ 5. Deploy Docker Container Locally
- script: |
    echo "Pulling image from Docker Hub..."
    docker pull $(dockerHubUsername)/$(imageName):$(imageTag)

    echo "Stopping existing container (if any)..."
    docker rm -f ubuntu-app || true

    echo "Running container on port 9090..."
    docker run -d --name ubuntu-app -p 9090:80 $(dockerHubUsername)/$(imageName):$(imageTag)

    echo "Deployment complete. Access app at: http://localhost:9090/"
  displayName: 'Deploy Docker Container on Local PC'
